# Оптимизация для работы с ограниченной памятью (~1 GB RAM)

## Проблема
- Сервер имеет ~957 MB RAM
- Swap отсутствует (0B)
- Контейнер падает с ошибкой Out of Memory (код 137) при загрузке модели

## Решение

### 1. Использовать модель `tiny`

**На сервере выполните:**

```bash
cd /opt/Abricol_Assistant

# Убедитесь, что модель tiny установлена в .env
grep STT_MODEL_SIZE .env

# Если не tiny, измените:
sed -i 's/STT_MODEL_SIZE=.*/STT_MODEL_SIZE=tiny/g' .env

# Проверьте
cat .env | grep STT_MODEL_SIZE
```

### 2. Обновить код с оптимизациями

```bash
# Получите последние изменения
git pull origin master
```

### 3. Пересобрать и перезапустить контейнер

```bash
# Остановите контейнер
docker-compose down

# Пересоберите образ (с оптимизациями)
docker-compose build --no-cache

# Запустите контейнер
docker-compose up -d

# Проверьте логи
docker-compose logs -f
```

### 4. Проверить лимиты памяти

После запуска проверьте, что лимиты установлены:

```bash
# Проверьте лимиты контейнера
docker stats abricol-assistant --no-stream
```

Должно показать что-то вроде:
```
CONTAINER ID   NAME                MEM USAGE / LIMIT   MEM %
...            abricol-assistant   250MiB / 450MiB     55.56%
```

## Ожидаемый результат

После оптимизации:
- ✅ Контейнер не падает от нехватки памяти
- ✅ Модель `tiny` загружается успешно (~39 MB)
- ✅ Транскрибация работает стабильно
- ✅ Использование памяти в пределах 400-450 MB

## Если проблемы сохраняются

1. **Проверьте текущее использование памяти:**
   ```bash
   free -h
   docker stats
   ```

2. **Посмотрите логи при голосовом сообщении:**
   ```bash
   docker-compose logs -f
   ```
   Отправьте голосовое сообщение боту и смотрите логи.

3. **Проверьте, что конвертация работает:**
   В логах должны быть:
   - "Голосовое сообщение скачано"
   - "Конвертация .oga в .wav"
   - "Загрузка модели STT (размер: tiny)"
   - "Транскрибация завершена"

## Дополнительная оптимизация (если нужно)

Если все еще не хватает памяти, можно:

1. **Создать swap на сервере** (не рекомендуется для производительности, но поможет избежать OOM):
   ```bash
   # Создать swap файл 512 MB
   sudo fallocate -l 512M /swapfile
   sudo chmod 600 /swapfile
   sudo mkswap /swapfile
   sudo swapon /swapfile
   
   # Сделать постоянным (добавить в /etc/fstab)
   echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
   ```

2. **Уменьшить лимит памяти контейнера** в `docker-compose.yml`:
   ```yaml
   deploy:
     resources:
       limits:
         memory: 400M  # Вместо 450M
   ```

## Проверка работы

После всех изменений:

1. Откройте логи: `docker-compose logs -f`
2. Отправьте голосовое сообщение боту
3. Проверьте, что:
   - Нет ошибок Out of Memory
   - Транскрибация завершается успешно
   - Результат распознавания появляется в боте

