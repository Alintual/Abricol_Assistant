services:
  abricol-bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: abricol-assistant
    restart: "no"
    
    # Переменные окружения из .env файла
    env_file:
      - .env
    
    # Переменные окружения (можно переопределить в .env)
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      # Переменные для кэша моделей faster-whisper
      - HF_HOME=/app/.cache/huggingface
      - XDG_CACHE_HOME=/app/.cache
      - TMPDIR=/tmp
    
    # Монтирование томов для сохранения данных
    volumes:
      # Директория для данных (базы данных и файлы)
      - ./data:/app/data:rw
      # Данные базы знаний (PDF, изображения, структурированные тексты)
      - ./src/knowledge/data:/app/src/knowledge/data:ro
      # Кэш моделей faster-whisper (для ускорения последующих запусков)
      - ./cache/models:/app/.cache/huggingface:rw
    
    # Сеть (если нужна)
    networks:
      - abricol-network
    
    # Ограничения ресурсов для предотвращения OOM
    # Ограничиваем память контейнера, чтобы не съедать всю RAM сервера
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G  # Максимум 1GB как требуется
        reservations:
          cpus: '0.5'
          memory: 300M  # Минимум для запуска

networks:
  abricol-network:
    driver: bridge

